CHEZMOI_TMP="$(mktemp -d -t chezmoi.XXXXXXXX)"

if [ ! -e "$HOME/.ssh" ]; then
    echo "@@@@@@@@@@@ Creating ssh config directory" >&2
    mkdir -m go= -p "$HOME/.ssh"
fi

if [ ! -e "$HOME/.ssh/known_hosts" ]; then
    echo "@@@@@@@@@@@ Adding github to known ssh hosts" >&2
    ssh-keyscan github.com 2>/dev/null > "$HOME/.ssh/known_hosts"
fi

ARGS="init joke --apply"
if [ -e "$SSH_TTY" ]; then
    echo "@@@@@@@@@@@ Cloning via ssh" >&2
    ARGS="$ARGS --ssh"
fi

echo "@@@@@@@@@@@ Starting chezmoi" >&2
sh -c "$(curl -fsLS https://chezmoi.io/get)" -b "$CHEZMOI_TMP" -- $ARGS
echo "@@@@@@@@@@@ Finished chezmoi" >&2

rm -rf -- "$CHEZMOI_TMP"
echo "@@@@@@@@@@@ Restarting shell" >&2
exec zsh
